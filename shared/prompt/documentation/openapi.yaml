# OpenAPI 3.0 for Picker API. Auth: Entra ID OAuth 2.0 (see security).
# Canonical route list: shared/prompt/to-do.md API surface.
# Copilot scenarios: shared/prompt/documentation/copilot-scenarios.md.

openapi: "3.0.3"
info:
  title: Picker API
  version: "1.0.0"
  description: |
    Backend for copilot-assisted flows. All routes except GET / require
    Entra ID OAuth 2.0 access token in Authorization header.
    Use OAuth 2.0 + Microsoft Entra ID in Copilot Studio.

servers:
  - url: /
    description: API base

paths:
  /:
    get:
      summary: Health check (no auth)
      operationId: getHome
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean

  /kv:
    get:
      summary: List keys; optional query prefix
      operationId: listKv
      parameters:
        - name: prefix
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Returns object with keys array
    post:
      summary: Write key-value
      operationId: postKv
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [key]
              properties:
                key: { type: string }
                value: {}
      responses:
        "200":
          description: Returns object with key
        "400":
          description: Validation error

  /kv/{key}:
    get:
      summary: Read value by key
      operationId: getKv
      parameters:
        - name: key
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Value or null
    delete:
      summary: Delete one key
      operationId: deleteKv
      parameters:
        - name: key
          in: path
          required: true
          schema: { type: string }
      responses:
        "204":
          description: No Content

  /scripts:
    get:
      summary: List store entries (Governance-verified)
      operationId: listScripts
      responses:
        "200":
          description: Returns object with entries array

  /scripts/{path}:
    get:
      summary: Read store file by path
      operationId: getScript
      parameters:
        - name: path
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: File content
        "404":
          description: Not found
    post:
      summary: Write store file at path
      operationId: postScript
      parameters:
        - name: path
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          text/plain:
            schema: { type: string }
      responses:
        "201":
          description: Created
        "400":
        "403":
        "500":

  /script/mutate:
    post:
      summary: Mutate store file via LLM (Governance)
      operationId: postScriptMutate
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [path]
              properties:
                path: { type: string }
                intent: { type: string }
                options: { type: object }
      responses:
        "200":
          description: Returns ok and replacements count
        "4xx":
        "5xx":
          description: Returns ok false with status and body

  /identity/actors:
    get:
      summary: List actors; query name or display_name
      operationId: listActors
      parameters:
        - name: name
          in: query
          schema: { type: string }
        - name: display_name
          in: query
          schema: { type: string }
      responses:
        "200":
          description: actor_id, display_name, level, progress[]
    post:
      summary: Create actor (display_name required)
      operationId: postActor
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [display_name]
              properties:
                display_name: { type: string }
                level: { type: string }
                progress: {}
      responses:
        "201":
          description: Actor with actor_id
        "400":

  /identity/actors/{id}:
    get:
      summary: Read actor by id
      operationId: getActor
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Actor object
        "404":
    patch:
      summary: Update actor (partial display_name, level, progress)
      operationId: patchActor
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema: { type: object }
      responses:
        "200":
        "404":

  /mirror/content/items/{id}:
    get:
      summary: Read content item (Mirror backup)
      operationId: getMirrorContentItem
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
        "404":
    patch:
      summary: Update content item
      operationId: patchMirrorContentItem
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema: { type: object }
      responses:
        "200":
        "404":

  /mirror/content/items:
    post:
      summary: Create content item (Mirror)
      operationId: postMirrorContentItem
      requestBody:
        content:
          application/json:
            schema: { type: object }
      responses:
        "201":
        "400":

  /mirror/content/worksheets/{id}:
    get:
      summary: Read worksheet meta (Mirror)
      operationId: getMirrorWorksheet
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
        "404":

  /mirror/content/worksheets:
    post:
      summary: Create worksheet (atomic). Body title, item_ids.
      operationId: postMirrorWorksheets
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [item_ids]
              properties:
                title: { type: string }
                item_ids:
                  type: array
                  items: { type: string }
      responses:
        "201":
          description: Worksheet
        "400":

  /sources:
    get:
      summary: List sources (full)
      operationId: listSources
      responses:
        "200":
          description: Source[]
    post:
      summary: Collect and store a source
      operationId: postSource
      requestBody:
        content:
          application/json:
            schema: { type: object }
      responses:
        "201":
        "400":

  /sources/{id}:
    get:
      summary: Source by id
      operationId: getSource
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
        "404":

  /sources/{id}/extract:
    post:
      summary: Extract concept/subject IDs from source body (LLM); save to source
      operationId: postSourceExtract
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema: { type: object }
      responses:
        "200":
          description: Returns ok, concept_ids, optional subject_id, extracted_at
        "4xx":
        "5xx":

  /mirror/schedule/due:
    get:
      summary: List schedule items due in range
      operationId: getScheduleDue
      parameters:
        - name: actor_id
          in: query
          required: true
          schema: { type: string }
        - name: from
          in: query
          schema: { type: string }
        - name: to
          in: query
          schema: { type: string }
      responses:
        "200":
          description: Returns object with items array

  /mirror/schedule/plan/weekly:
    get:
      summary: Weekly plan by week number
      operationId: getSchedulePlanWeekly
      parameters:
        - name: actor_id
          in: query
          required: true
          schema: { type: string }
        - name: week_start
          in: query
          schema: { type: string }
        - name: level
          in: query
          schema: { type: string }
      responses:
        "200":

  /mirror/schedule/plan/annual:
    get:
      summary: Annual curriculum
      operationId: getSchedulePlanAnnual
      parameters:
        - name: year
          in: query
          schema: { type: integer }
        - name: level
          in: query
          schema: { type: string }
      responses:
        "200":

  /mirror/schedule/items:
    get:
      summary: List schedule items
      operationId: listScheduleItems
      parameters:
        - name: actor_id
          in: query
          required: true
          schema: { type: string }
        - name: source_id
          in: query
          schema: { type: string }
      responses:
        "200":
          description: Returns object with items array
    post:
      summary: Create schedule item
      operationId: postScheduleItem
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [actor_id, source_id, unit_id]
              properties:
                actor_id: { type: string }
                source_id: { type: string }
                unit_id: { type: string }
      responses:
        "201":
        "400":

  /mirror/schedule/items/{id}/review:
    post:
      summary: Record review (grade 1â€“4)
      operationId: postScheduleItemReview
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                grade: { type: integer }
                reviewed_at: { type: string }
      responses:
        "200":
        "404":

  /mirror/lexis/entries:
    get:
      summary: List lexis entries (Mirror); query source_id, days, or q
      operationId: getMirrorLexisEntries
      parameters:
        - name: source_id
          in: query
          schema: { type: string }
        - name: days
          in: query
          schema: { type: integer }
        - name: q
          in: query
          schema: { type: string }
          description: Utterance (regex + LLM fallback)
      responses:
        "200":
          description: Returns object with entries array
        "400":

components:
  securitySchemes:
    EntraBearer:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Microsoft Entra ID OAuth 2.0 access token.
        In Copilot Studio use OAuth 2.0 with Identity provider Microsoft Entra ID
        (Client ID, Tenant ID from Picker app registration).

security:
  - EntraBearer: []
